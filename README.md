# المختبر الفيزيائي التفاعلي (M5StickC PLUS2)

منظومة تعليمية عملية تعتمد على لوحة **M5StickC PLUS2** (ESP32) لتنفيذ وشرح أربع تجارب فيزيائية أساسية + محاكاة نظرية عبر واجهة ويب محلية:

1. تجربة المقذوفات
2. تجربة البندول البسيط
3. تجربة السقوط الحر
4. تجربة الاحتكاك على سطح مائل
5. إضافة: أربع صفحات محاكاة (Projectile / Pendulum / Freefall / Friction)

> كل ذلك مع نظام صوتي تفاعلي غير حاجز (Non‑Blocking Event‑Driven Audio) وفلاتر Kalman لتنعيم بيانات المستشعر.

---
## ✅ المزايا الرئيسية
- تشغيل ذاتي وواجهة ويب باللغة العربية (اتصال مباشر عبر الشبكة).  
- نظام أحداث صوتي احترافي يعتمد تسلسلات نغمات قصيرة لكل حالة (بدء، قياس، ذروة، سقوط، انزلاق، إنجاز).  
- فصل منطقي منظم: `main.cpp` للإدارة، و `experiments.*` للمنطق، و `sound.*` للصوت، و `filters.hpp` للفلتر.  
- دعم إعادة المعايرة بضغطة زر (زر B مع الضغط المطوّل).  
- وضع طاقة منخفضة تلقائي بعد خمول (Sleep + إعادة تشغيل).  
- محاكاة نظرية داخل المتصفح لشرح العلاقات الرياضية.  

---
## 🧪 وصف التجارب
### 1. تجربة المقذوفات
تقيس السرعة الابتدائية للأداة عند قذفها وتحسب: زمن التحليق، أقصى ارتفاع، المدى الأفقي.
- بدء التجربة من صفحة الويب (إدخال الكتلة وزاوية القذف).
- رصد القذف (تسارع زائد)، ثم الدخول في مرحلة السقوط الحر، ثم الهبوط.
- يعتمد على التغير في التسارع المحوري بعد طرح المركبة الثابتة للجاذبية.

### 2. تجربة البندول البسيط
تحسب الزمن الدوري والتردد وقيمة الجاذبية المحلية (g) استناداً إلى قياس عدة اهتزازات.
- يُطلب طول الخيط وعدد الاهتزازات المراد قياسها.
- يكشف الذروة (Peaks) عبر تحليل تغيّر الإشارة المعالجة Kalman + مرشح انسيابي.

### 3. تجربة السقوط الحر
تحسب زمن السقوط وقيمة g من مسافة سقوط معلومة.
- يبدأ الحساب عند دخول التسارع الكلي منطقة شبه انعدام الوزن.
- يتوقف عند رصد صدمة اصطدام (تسارع كبير مفاجئ).

### 4. تجربة الاحتكاك
تحسب معامل الاحتكاك الساكن μ من الزاوية الحرجة للانزلاق: μ ≈ tan(θ).
- يميل المستخدم السطح ببطء حتى يبدأ الانزلاق.
- يسجل النظام الزاوية لحظة الانفلات ثم يحسب μ.

### 5. صفحات المحاكاة (محاكاة رياضية)
لا تعتمد على الحساس، بل تعطي تصوراً نظرياً فوريًا:
- مقذوفات: حساب المدى، الزمن، الارتفاع.
- بندول: حساب الزمن الدوري من L و g.
- سقوط حر: حساب زمن السقوط من المسافة.
- احتكاك: مقارنة قوة الجاذبية الموازية وقوة الاحتكاك القصوى.

---
## 🎵 نظام الصوت (Event‑Driven Audio)
تم استبدال النغمات الحاجزة السابقة بنظام تسلسلات (Sequences) غير حاجز:
- كل حدث (Event) مثل: `Startup`, `CalibrateStart`, `PendulumPeak`, `ExperimentDone` له تسلسل نغمات خاص.
- يتم تشغيل النغمات بالتتابع داخل `Sound::update()` دون تعطيل الحلقة الرئيسية.
- إضافة أحداث جديدة تتم عبر تعديل enum في `sound.hpp` وربطها بتسلسل في `sound.cpp`.

مثال إضافة حدث:
1. إضافة اسم الحدث في `enum class Event`.
2. إنشاء مصفوفة `SeqStep` جديدة.
3. تحديث دالة `mapEvent()` لربط الحدث بالتسلسل.
4. استخدام `Sound::trigger(Event::NewEvent)` في المنطق.

---
## 🔄 تدفق التنفيذ
1. تشغيل وتهيئة (عرض + معايرة IMU + تشغيل حدث Startup).
2. محاولة الاتصال بالشبكة المخزنة، وإلا يدخل وضع إعداد WiFi (AP ذاتي: اسم الشبكة `M5-Experiment-Setup`).
3. عند الاتصال: تشغيل خادم ويب محلي يعرض لوحة التحكم.
4. المستخدم يفتح المتصفح إلى عنوان الـ IP الظاهر على الشاشة.
5. اختيار تجربة → بدء → الجهاز يجمع بيانات → انتهاء → النتائج تظهر في الصفحة.
6. خمول طويل → وضع توفير الطاقة.

---
## ⚙️ المتطلبات
- لوحة: M5StickC PLUS2 (ESP32-PICO-V3-02).
- PlatformIO (بيئة التطوير) + إطار Arduino.
- المكتبات (تنزل تلقائياً): M5Unified، ArduinoJson، WebServer، DNSServer، EEPROM.

---
## 🧭 المعايرة (Calibration)
تتم تلقائياً عند التشغيل:
- اجعل الجهاز ثابتًا على سطح أفقي لمدة ثانيتين أثناء عبارة "Calibrating...".
- يمكن إعادة المعايرة: الضغط المطول على زر B (حوالي 3 ثوانٍ).

القيم المخزنة:
- محور Z للمقذوفات.
- محور Y للبندول.
- محور X للاحتكاك.

---
## 📡 إعداد WiFi
إذا لم يجد بيانات محفوظة:
1. ينشئ نقطة وصول: `M5-Experiment-Setup`.
2. اتصل بها من الهاتف / الحاسوب.
3. افتح المتصفح: 192.168.4.1 (أي رابط يُحول تلقائياً Captive Portal).
4. اختر الشبكة وأدخل كلمة المرور → إعادة تشغيل تلقائي.

بيانات الدخول تحفظ في EEPROM (بسيطة وغير مشفرة – للاستخدام التعليمي فقط).

---
## 🖥️ واجهة الويب
تشمل:
- عمود للتجارب العملية.
- عمود للمحاكاة النظرية.
- نغمات تفاعل بسيطة عند تمرير الفأرة (على المتصفح فقط عبر Tone.js).
- نافذة مساعدة (معلومات التواصل).

---
## 🔐 سلامة وتجهيزات
- يُفضّل إجراء تجارب السقوط الحر فوق سطح آمن (إسفنجي أو ناعم).
- تجارب المقذوفات: تجنب القذف على ارتفاعات قد تُتلف الجهاز.
- الاحتكاك: إمالة تدريجية لتفادي السقوط العنيف.

---
## 🧪 كيفية البناء والرفع (PlatformIO)
ضمن VS Code:
1. افتح المشروع.
2. من الشريط الجانبي: PlatformIO → Build.
3. وصل اللوحة عبر USB.
4. اختر المنفذ إذا طُلب.
5. اضغط Upload.

أو سطر أوامر:
```bash
pio run
pio run -t upload
```

---
## 🛠️ الهيكل البرمجي
```
src/
  main.cpp          ← التهيئة + WiFi + REST + حلقة رئيسية
  experiments.hpp   ← تعريف المتغيرات وأنواع الحالة
  experiments.cpp   ← منطق التجارب الفيزيائية + كشف الأحداث
  filters.hpp       ← كائن KalmanFilter بسيط للتنعيم
  sound.hpp/.cpp    ← نظام الصوت الحدثي (Sequences)
platformio.ini      ← إعدادات بيئة PlatformIO
```

---
## 🗂️ توسيع مستقبلي مقترح
- إضافة تسجيل CSV للقياسات عبر SPIFFS أو بطاقة خارجية.
- بث WebSocket حي للبيانات (رسم منحنى زمني).
- دعم تجربة الطاقة الحركية/الإزاحة (عربة + مسار).
- استعمال مرشح تكيفي (Complementary أو Mahony) لتحسين زوايا الاحتكاك.

---
## ❓ استكشاف الأخطاء
| العرض | التفسير | الإجراء |
|-------|---------|---------|
| لا عنوان IP | فشل اتصال الشبكة | ادخل وضع الإعداد (إعادة تشغيل بدون WiFi معروف) |
| نتائج صفرية | لم تُلتقط الأحداث | تأكد من الحركة الصحيحة وفق التعليمات |
| الصوت صامت | مكبر معطل أو حجم | تأكد من `M5.Speaker.begin()` وقطع الطاقة |
| انزلاق الاحتكاك مبكر | سطح غير مناسب | جرّب سطحًا أكثر خشونة |

---
## 👤 حقوق ومعلومات
© وزارة التربية والتعليم – سلطنة عمان 2023  
التطوير البرمجي: أحمد القصابي  
الغرض: دعم التعليم العملي في المختبرات المدرسية.  

> هذا المشروع لأغراض تعليمية، ويمكن تحسينه أو تعديله داخلياً.

---
## 💬 تواصل
للدعم والاستفسار:  
الهاتف / واتساب: +968 9984 8382  

---
### ملاحظات ختامية
إذا رغبت بإضافة لغة ثانية (إنجليزي) يمكن إنشاء `README.en.md` مع تلخيص مختصر، أو جعل الأقسام ثنائية اللغة.

بالتوفيق في التدريس والتجارب! 🔬
